<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>나의 작업 공간</title>
    <link id="theme-link"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js"></script>

    <style>
      /* 스위치 컨테이너 */
      .theme-switch {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        font-weight: 500;
      }
      /* 트랙 */
      .theme-switch .track {
        width: 60px;
        height: 28px;
        border-radius: 14px;
        background-color: #4a4a4a;
        position: relative;
        transition: background-color .3s;
        margin-right: 8px;
      }
      /* 토글 원 (thumb) */
      .theme-switch .thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: white;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: left .3s;
        box-shadow: 0 0 2px rgba(0,0,0,.3);
      }
      /* 다크 모드일 때 */
      .theme-switch.dark .track {
        background-color: #e0e0e0;
      }
      .theme-switch.dark .thumb {
        left: 34px;  /* 60 - 24 - 2 = 34 */
      }
    </style>

</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mt-3">
        <h4>My work space</h4>

        <!-- 테마 스위치 -->
        <div id="theme-switch" class="theme-switch">
          <div class="track"><div class="thumb"></div></div>
          <span id="theme-label">🌙Mode</span>
        </div>

    </div>
    <div class="row">
        {% block content %}{% endblock %}
    </div>
</div>
<script>
    $(document).ready(function() {
        var calendar = $('#calendar').fullCalendar({
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            events: '/all_events',
            selectable: true,
            selectHelper: true,
            editable: true,
            eventLimit: true,
            select: function (start, end, allDay) {
                var title = prompt("Enter Event Title");
                if (title) {
                    var start = $.fullCalendar.formatDate(start, "Y-MM-DD HH:mm:ss");
                    var end = $.fullCalendar.formatDate(end, "Y-MM-DD HH:mm:ss");
                    $.ajax({
                        type: "GET",
                        url: "/add_event",
                        data: {'title': title, 'start': start, 'end': end},
                        dataType: "json",
                        success: function (data) {
                            calendar.fullCalendar('refetchEvents');
                            alert("추가 했습니다!");
                        },
                        error: function (data) {
                            alert("문제가 발생했어요!");
                        }
                    });
                }
            },
            eventDrop: function (event) {
                var start = $.fullCalendar.formatDate(event.start, "Y-MM-DD HH:mm:ss");
                var end = $.fullCalendar.formatDate(event.end, "Y-MM-DD HH:mm:ss");
                var title = event.title;
                var id = event.id;
                $.ajax({
                    type: "GET",
                    url: "/update",
                    data: {'title': title, 'start': start, 'end': end, 'id': id},
                    dataType: "json",
                    success: function (data) {
                        calendar.fullCalendar('refetchEvents');
                        alert("업데이트 완료");
                    },
                    error: function (data) {
                        alert("문제가 발생했어요!");
                    }
                });
            },
            eventClick: function (event) {
                if (confirm("이것을 삭제 하시겠습니까?")) {
                    var id = event.id;
                    $.ajax({
                        type: "GET",
                        url: "/remove",
                        data: {'id': id},
                        dataType: "json",
                        success: function (data) {
                            calendar.fullCalendar('refetchEvents');
                            alert("삭제 했습니다");
                        },
                        error: function (data) {
                            alert("문제가 발생했어요!");
                        }
                    });
                }
            },

        });
    });
</script>

<script>
  const THEME_SWITCH = document.getElementById('theme-switch');
  const THEME_LABEL  = document.getElementById('theme-label');
  const THEME_LINK   = document.getElementById('theme-link');

  const LIGHT_CSS = "https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css";
  const DARK_CSS  = "https://cdn.jsdelivr.net/npm/bootswatch@5/dist/darkly/bootstrap.min.css";

  // 초기화: 로컬스토리지 값 불러오기
  const saved = localStorage.getItem('theme') || 'light';

  function applyTheme(mode) {
    if (mode === 'dark') {
      THEME_LINK.href = DARK_CSS;
      THEME_SWITCH.classList.add('dark');
      THEME_LABEL.textContent = '☀️Mode';
    } else {
      THEME_LINK.href = LIGHT_CSS;
      THEME_SWITCH.classList.remove('dark');
      THEME_LABEL.textContent = '🌙Mode';
    }
    localStorage.setItem('theme', mode);
  }

  // 초기 적용
  applyTheme(saved);

  // 스위치 클릭 시 테마 토글
  THEME_SWITCH.addEventListener('click', () => {
    const isDark = THEME_SWITCH.classList.toggle('dark');
    applyTheme(isDark ? 'dark' : 'light');
  });
</script>

</body>
</html>