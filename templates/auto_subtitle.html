{% extends 'base.html' %}

{% block content %}

<head>
  <meta charset="UTF-8">
    <div class="d-flex justify-content-start mb-3">
      <a href="{% url 'home' %}" class="btn btn-secondary btn-sm me-2">
        ← Home
      </a>
    </div>

  <title>자동 자막 추출</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:1em; background:#f9f9f9; }
    #controls { text-align:center; margin-bottom:1em; }
    #controls button {
      margin:0 .3em; padding:.5em 1em;
      cursor:pointer; border:none; border-radius:4px;
      background:#007bff; color:#fff;
      transition: background .2s;
    }
    #controls button:hover { background:#0056b3; }

    #video-container {
      position: relative; width:80%; max-width:1200px;
      height:450px; margin:0 auto 1em;
      border:1px solid #ccc; background:#000;
      overflow:hidden; border-radius:8px;
    }
    #screen-video { width:100%; height:100%; object-fit:contain; }

    #overlay, #selection-rect {
      position:absolute; top:0; left:0;
    }
    #overlay {
      width:100%; height:100%;
      background:rgba(0,0,0,0.2);
      cursor:crosshair; display:none;
    }
    #selection-rect {
      border:2px dashed #0f0; display:none;
    }

    /* 빨강 테두리 */
    #debug-canvas {
      border: 2px solid red;
      display: block;
      margin: 1em auto;
    }

    /* 화자 지정 */
    #speaker-controls {
      width:80%; max-width:1200px; margin:0 auto 1em;
      padding:1em; background:#fff; border:1px solid #ddd; border-radius:6px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    #speaker-controls h3 { margin:0 0 .8em; color:#333; }
    #speaker-list { display:flex; flex-wrap:wrap; gap:.5em; }
    .speaker-entry {
      display:flex; align-items:center;
      background:#f1f1f1; border-radius:4px; padding:.3em .5em;
    }
    .speaker-entry input {
      border:1px solid #ccc; border-radius:4px;
      padding:.3em .5em; font-size:.9em; width:80px; margin-right:.4em;
    }
    .speaker-entry button {
      border:none; background:#28a745; color:#fff;
      padding:.3em .6em; border-radius:4px;
      font-size:.9em; cursor:pointer;
      transition: background .2s;
    }
    .speaker-entry button:hover { background:#218838; }
    #add-speaker {
      margin-top:.8em; display:inline-block;
      font-size:1.2em; padding:.2em .6em;
      background:#17a2b8; color:#fff; border:none; border-radius:4px;
      cursor:pointer; transition: background .2s;
    }
    #add-speaker:hover { background:#117a8b; }

    /* 실시간 자막 (가운데 정렬) */
    #real-time-sub {
      display:block; width:80%; max-width:1200px;
      min-height:200px; margin:0 auto 1em;
      border:1px solid #999; font-family:monospace;
      padding:.8em; resize:vertical; border-radius:4px; background:#fff;
    }
  </style>
  <script src="https://unpkg.com/tesseract.js@2/dist/tesseract.min.js"></script>
</head>
<body>
  <h1 style="text-align:center;">자동 자막 추출</h1>

  <div id="controls">
    <button id="btn-share">화면 공유 시작</button>
    <button id="btn-select">영역 선택 모드</button>
    <button id="btn-ocr-toggle">자막 추출 시작</button>
    <button id="btn-clear">자막 초기화</button>
  </div>

  <div id="video-container">
    <video id="screen-video" autoplay></video>
    <div id="overlay"></div>
    <div id="selection-rect"></div>
  </div>

  <canvas id="debug-canvas" width="0" height="0"></canvas>

  <!-- 화자 지정 UI -->
  <div id="speaker-controls">
    <h3>화자 지정</h3>
    <div id="speaker-list"></div>
    <button id="add-speaker">＋ 화자 추가</button>
  </div>

  <h2 style="text-align:center;">실시간 자막</h2>
  <!-- readonly 제거해서 바로 편집 가능 -->
  <textarea id="real-time-sub"></textarea>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // 요소 참조
    const btnShare  = document.getElementById('btn-share');
    const btnSelect = document.getElementById('btn-select');
    const btnOcr    = document.getElementById('btn-ocr-toggle');
    const btnClear  = document.getElementById('btn-clear');
    const video     = document.getElementById('screen-video');
    const overlay   = document.getElementById('overlay');
    const rectDiv   = document.getElementById('selection-rect');
    const debugCv   = document.getElementById('debug-canvas');
    const debugCtx  = debugCv.getContext('2d');
    const subBox    = document.getElementById('real-time-sub');
    const speakerList = document.getElementById('speaker-list');
    const addSpeaker  = document.getElementById('add-speaker');

    // 화자 입력창 생성 함수
    function createSpeakerEntry(name='') {
      const div = document.createElement('div');
      div.className = 'speaker-entry';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = '이름';
      input.value = name;

      const btn = document.createElement('button');
      btn.textContent = '등록';
      btn.onclick = () => {
        const nm = input.value.trim();
        if (!nm) return alert('이름을 입력하세요');
        subBox.value += `${nm}: `;
        subBox.focus();
      };

      div.append(input, btn);
      speakerList.appendChild(div);
    }

    // 초기 화자 1개
    createSpeakerEntry();
    addSpeaker.onclick = () => createSpeakerEntry();

    // OCR 관련 변수
    let selecting = false, startX=0, startY=0;
    let rect={x:0,y:0,w:0,h:0}, ocrInterval=null, prevText='';

    // 1) 화면 공유
    btnShare.onclick = async () => {
      const stream = await navigator.mediaDevices.getDisplayMedia({ video:true });
      video.srcObject = stream; await video.play();
    };

    // 2) 영역 선택
    btnSelect.onclick = () => {
      selecting = true; overlay.style.display='block'; rectDiv.style.display='none';
    };
    overlay.addEventListener('mousedown', e => {
      if (!selecting) return;
      const b = overlay.getBoundingClientRect();
      startX = e.clientX - b.left; startY = e.clientY - b.top;
      Object.assign(rectDiv.style,{
        left:startX+'px', top:startY+'px',
        width:'0px', height:'0px', display:'block'
      });
      const onMove = ev => {
        const cx=ev.clientX-b.left, cy=ev.clientY-b.top;
        const x=Math.min(startX,cx), y=Math.min(startY,cy);
        const w=Math.abs(cx-startX), h=Math.abs(cy-startY);
        Object.assign(rectDiv.style,{
          left:x+'px', top:y+'px',
          width:w+'px', height:h+'px'
        });
      };
      const onUp = ev => {
        document.removeEventListener('mousemove',onMove);
        document.removeEventListener('mouseup',onUp);
        overlay.style.display='none'; selecting=false;
        const ex=ev.clientX-b.left, ey=ev.clientY-b.top;
        rect={ x:Math.min(startX,ex), y:Math.min(startY,ey),
               w:Math.abs(ex-startX), h:Math.abs(ey-startY) };
      };
      document.addEventListener('mousemove',onMove);
      document.addEventListener('mouseup',onUp);
    });

    // 3) OCR 시작/중단
    btnOcr.onclick = () => {
      if (!ocrInterval) {
        if (!rect.w||!rect.h) return alert('먼저 영역을 선택하세요');
        btnOcr.textContent='자막 추출 중단'; btnOcr.style.background='#dc3545';

        ocrInterval = setInterval(async () => {
          // 좌표 보정
          const vb=video.getBoundingClientRect();
          const ar=video.videoWidth/video.videoHeight;
          let rw,rh,ox,oy;
          if (vb.width/vb.height>ar) {
            rh=vb.height; rw=rh*ar; ox=(vb.width-rw)/2; oy=0;
          } else {
            rw=vb.width; rh=rw/ar; ox=0; oy=(vb.height-rh)/2;
          }
          const sx=(rect.x-ox)*(video.videoWidth/rw);
          const sy=(rect.y-oy)*(video.videoHeight/rh);
          const sw=rect.w*(video.videoWidth/rw);
          const sh=rect.h*(video.videoHeight/rh);

          // 캔버스
          debugCv.width=sw; debugCv.height=sh;
          debugCtx.clearRect(0,0,sw,sh);
          debugCtx.drawImage(video,sx,sy,sw,sh,0,0,sw,sh);

          // 간단 전처리 (그레이스케일+이진화)
          const img = debugCtx.getImageData(0,0,sw,sh);
          for(let i=0;i<img.data.length;i+=4){
            const g = 0.299*img.data[i]+0.587*img.data[i+1]+0.114*img.data[i+2];
            const b = g>128?255:0;
            img.data[i]=img.data[i+1]=img.data[i+2]=b;
          }
          debugCtx.putImageData(img,0,0);

          // Tesseract AUTO PSM
          const { data:{ text }} = await Tesseract.recognize(
            debugCv,'kor+eng',
            { tessedit_pageseg_mode:Tesseract.PSM.AUTO }
          );
          const t=text.trim();
          if (t && t!==prevText) {
            prevText=t;
            subBox.value+=t+"\n";
            subBox.scrollTop=subBox.scrollHeight;
          }
        }, 500);

      } else {
        clearInterval(ocrInterval);
        ocrInterval=null;
        btnOcr.textContent='자막 추출 시작';
        btnOcr.style.background='#007bff';
      }
    };

    // 4) 초기화
    btnClear.onclick = () => {
      clearInterval(ocrInterval);
      ocrInterval=null; prevText=''; subBox.value='';
      rectDiv.style.display='none'; rect={x:0,y:0,w:0,h:0};
      btnOcr.textContent='자막 추출 시작'; btnOcr.style.background='#007bff';
      speakerList.innerHTML=''; createSpeakerEntry();
    };
  });
  </script>
{% endblock %}
